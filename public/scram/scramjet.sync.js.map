{"version":3,"file":"scramjet.sync.js","sources":["webpack://@mercuryworkshop/scramjet/./src/sync.ts"],"sourcesContent":["addEventListener(\n\t\"message\",\n\t({\n\t\tdata: {\n\t\t\tsab,\n\t\t\targs: [method, url, _, username, password],\n\t\t\tbody,\n\t\t\theaders,\n\t\t},\n\t}) => {\n\t\tconst view = new DataView(sab);\n\t\tconst u8view = new Uint8Array(sab);\n\n\t\tconst xhr = new XMLHttpRequest();\n\t\txhr.responseType = \"arraybuffer\";\n\n\t\t// force async since we need it to resolve to the sw\n\t\txhr.open(method, url, true, username, password);\n\n\t\tif (headers)\n\t\t\tfor (const [k, v] of Object.entries(headers)) {\n\t\t\t\txhr.setRequestHeader(k, v as string);\n\t\t\t}\n\n\t\txhr.send(body);\n\n\t\txhr.onload = () => {\n\t\t\tlet cursor = 1; // first byte is the lock\n\n\t\t\tview.setUint16(cursor, xhr.status);\n\t\t\tcursor += 2;\n\n\t\t\t// next write the header string\n\t\t\tconst headers = xhr.getAllResponseHeaders();\n\t\t\tview.setUint32(cursor, headers.length);\n\t\t\tcursor += 4;\n\n\t\t\tif (sab.byteLength < cursor + headers.length)\n\t\t\t\tsab.grow(cursor + headers.length);\n\t\t\tu8view.set(new TextEncoder().encode(headers), cursor);\n\t\t\tcursor += headers.length;\n\n\t\t\tview.setUint32(cursor, xhr.response.byteLength);\n\t\t\tcursor += 4;\n\n\t\t\tif (sab.byteLength < cursor + xhr.response.byteLength)\n\t\t\t\tsab.grow(cursor + xhr.response.byteLength);\n\t\t\tu8view.set(new Uint8Array(xhr.response), cursor);\n\n\t\t\t// release the lock, main thread will stop spinning now\n\t\t\tview.setUint8(0, 1);\n\t\t};\n\t\txhr.ontimeout =\n\t\t\txhr.onerror =\n\t\t\txhr.onabort =\n\t\t\t\t() => {\n\t\t\t\t\tconsole.error(\"xhr failed\");\n\t\t\t\t\tview.setUint8(0, 1);\n\t\t\t\t};\n\t}\n);\n"],"names":["addEventListener","sab","method","url","_","username","password","body","headers","view","DataView","u8view","Uint8Array","xhr","XMLHttpRequest","k","v","Object","cursor","TextEncoder","console"],"mappings":";;;;;AAAAA,iBACC,WACA,CAAC,EACA,MAAM,EACLC,GAAG,EACH,MAAM,CAACC,QAAQC,KAAKC,GAAGC,UAAUC,SAAS,EAC1CC,IAAI,EACJC,OAAO,EACP,EACD;IACA,MAAMC,OAAO,IAAIC,SAAST;IAC1B,MAAMU,SAAS,IAAIC,WAAWX;IAE9B,MAAMY,MAAM,IAAIC;IAChBD,IAAI,YAAY,GAAG;IAEnB,oDAAoD;IACpDA,IAAI,IAAI,CAACX,QAAQC,KAAK,MAAME,UAAUC;IAEtC,IAAIE,SACH,KAAK,MAAM,CAACO,GAAGC,EAAE,IAAIC,OAAO,OAAO,CAACT,SAAU;QAC7CK,IAAI,gBAAgB,CAACE,GAAGC;IACzB;IAEDH,IAAI,IAAI,CAACN;IAETM,IAAI,MAAM,GAAG;QACZ,IAAIK,SAAS,GAAG,yBAAyB;QAEzCT,KAAK,SAAS,CAACS,QAAQL,IAAI,MAAM;QACjCK,UAAU;QAEV,+BAA+B;QAC/B,MAAMV,UAAUK,IAAI,qBAAqB;QACzCJ,KAAK,SAAS,CAACS,QAAQV,QAAQ,MAAM;QACrCU,UAAU;QAEV,IAAIjB,IAAI,UAAU,GAAGiB,SAASV,QAAQ,MAAM,EAC3CP,IAAI,IAAI,CAACiB,SAASV,QAAQ,MAAM;QACjCG,OAAO,GAAG,CAAC,IAAIQ,cAAc,MAAM,CAACX,UAAUU;QAC9CA,UAAUV,QAAQ,MAAM;QAExBC,KAAK,SAAS,CAACS,QAAQL,IAAI,QAAQ,CAAC,UAAU;QAC9CK,UAAU;QAEV,IAAIjB,IAAI,UAAU,GAAGiB,SAASL,IAAI,QAAQ,CAAC,UAAU,EACpDZ,IAAI,IAAI,CAACiB,SAASL,IAAI,QAAQ,CAAC,UAAU;QAC1CF,OAAO,GAAG,CAAC,IAAIC,WAAWC,IAAI,QAAQ,GAAGK;QAEzC,uDAAuD;QACvDT,KAAK,QAAQ,CAAC,GAAG;IAClB;IACAI,IAAI,SAAS,GACZA,IAAI,OAAO,GACXA,IAAI,OAAO,GACV;QACCO,QAAQ,KAAK,CAAC;QACdX,KAAK,QAAQ,CAAC,GAAG;IAClB;AACH"}